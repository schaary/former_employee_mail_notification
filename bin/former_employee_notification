#!/usr/bin/env ruby

require 'ruby-plsql'
require 'thor'
require 'awesome_print'
require 'date'
require 'active_support/core_ext' 
require 'pry'

class FormerEmployeeMailNotification < Thor
  desc "refresh","refresh infos about former employee"
  def refresh 
    initialize_time_slots
    list = to_hash fetch
#    ap list.select { |s| two_months_ago s[:endtime] }
    binding.pry
  end

private 
  def fetch
    connect

    list = {}
    plsql.mitarbeiter_account_pkg.formerEmployeeList do |cursor|
      list = cursor.fetch_all
    end
    list
  end

  def initialize_time_slots
    @time_slots = {
      one:   {start: Time.now.months_ago(1).at_beginning_of_month, 
              end:   Time.now.months_ago(1).at_end_of_month},
      two:   {start: Time.now.months_ago(2).at_beginning_of_month, 
              end:   Time.now.months_ago(2).at_end_of_month},
      three: {start: Time.now.months_ago(3).at_beginning_of_month, 
              end:   Time.now.months_ago(3).at_end_of_month},
      four:  {start: Time.now.months_ago(4).at_beginning_of_month, 
              end:   Time.now.months_ago(4).at_end_of_month},
      five:  {start: Time.now.months_ago(5).at_beginning_of_month, 
              end:   Time.now.months_ago(5).at_end_of_month},
      six:   {start: Time.now.months_ago(6).at_beginning_of_month, 
              end:   Time.now.months_ago(6).at_end_of_month},
    }
  end

  def to_hash list
    list.inject([]) do |new_list, array|
      new_list.push(
       {uid: array[3],
        mail: array[4],
        firstname: array[1],
        lastname: array[0],
        gender: array[2],
        #title: array[5],
        endtime: make_date(array[5]),
        endtime_group: select_endtime_group(make_date(array[5]))}
      )
    end
  end

  def select_endtime_group date
    return :seven if date.nil?

    @time_slots.select { |k,v| (v[:start]..v[:end]).cover? date }.keys.first
  end

  def connect
    plsql.connection ||= OCI8.new( 
      ENV.fetch('UMT_USER'), 
      ENV.fetch('UMT_PASSWORD'), 
      ENV.fetch('UMT_SID') )
  end

  def make_date date
    return nil if date.nil?

    Date.parse date
  end
end

FormerEmployeeMailNotification.start
