#!/usr/bin/env ruby

require 'ruby-plsql'
require 'thor'
require 'awesome_print'
require 'date'
require 'active_support/core_ext' 
require 'pry'

class FormerEmployeeMailNotification < Thor
  desc "refresh","refresh infos about former employee"
  def refresh 
    list = to_hash fetch
    ap list.select { |s| two_months_ago s[:endtime] }
  end

private 
  def fetch
    connect

    list = {}
    plsql.mitarbeiter_account_pkg.formerEmployeeList do |cursor|
      list = cursor.fetch_all
    end
    list
  end

  def to_hash list
    list.inject([]) do |new_list, array|
      new_list.push(
       {uid: array[3],
        mail: array[4],
        firstname: array[1],
        lastname: array[0],
        gender: array[2],
        #title: array[5],
        endtime: make_date(array[5])}
      )
    end
  end

  def connect
    plsql.connection ||= OCI8.new( 
      ENV.fetch('UMT_USER'), 
      ENV.fetch('UMT_PASSWORD'), 
      ENV.fetch('UMT_SID') )
  end

  def two_months_ago date
    return false if date.nil?
    year = Date.current.months_ago(2).year
    month = Date.current.months_ago(2).month

    return true if date.year == year && date.month == month
    return false
  end

  def make_date date
    return nil if date.nil?

    Date.parse date
  end
end

FormerEmployeeMailNotification.start
